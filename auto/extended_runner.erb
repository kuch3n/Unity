/*=======Extended Runner=====*/

bool UnityStringStartsWith(const char *pre, const char *str);
int UnityGetCommandLineOptions(int argc, const char* argv[]);

typedef struct
{
  UnityTestFunction func;
  const char* name;
  const char* file;
  const char* suite;
  UNITY_LINE_TYPE line_num;
  /* JUnitTestResult result;*/
} UnityTestCase;

struct
{
    bool printCases;
    bool printSuites;
    bool printReporters;
    char const * caseFilter;
} UnityArguments;

UnityTestCase UnityTestCases[<%= count_tests(tests) %>] = {
<% tests.each_with_index do |test, idx| %>
<% if (!@options[:use_param_tests]) || test[:args].nil? || test[:args].empty? %>
    [<%= idx %>] = { .func = <%= test[:test] %>, .name = "<%= test[:test] %>", .line_num = <%= test[:line_number] %>, .suite = NULL },
<% else %>
<% test[:args].each.with_index(1) do |args, arg_idx| %>
<%  %>
    [<%= idx %>] = { .func = runner_args<%= arg_idx %>_<%= test[:test] %>, .name = "<%= test[:test] %>(<%= args.concat %>)", .suite = "<%= test[:test] %>"  },
<% end %>
<% end %>
<% end %>
};

int main(int argc, const char* argv[])
{
    int exit = 0;

    exit = UnityGetCommandLineOptions(argc, argv);

    if(UnityArguments.printCases)
    {
        // UnityListTestCases();
    }

    if(exit == 1)
    {
        return 0;
    }
}

#define VERSION "0.0.1"

int UnityGetCommandLineOptions(int argc, const char* argv[])
{
    int i;

    UnityArguments.caseFilter = NULL;
    UnityArguments.printCases = false;
    UnityArguments.printReporters = false;
    UnityArguments.printSuites = false;

    if(argc == 1)
    {
        return 0;
    }

    for(int i = 1; i < argc; i++)
    {
        if(strcmp(argv[i], "-h") == 0 || strcmp(argv[i], "--help") == 0)
        {
            printf("doctest version is \"%s\"\n\n", VERSION);
            printf("-h,   --help             print this message\n");
            printf("-v,   --version          print the version\n");
            printf("-ltc, --list-test-cases  list all tests by name\n");
            printf("-lts, --list-test-suites list test suites\n");
            printf("-lr,  --list-reporters   list all registered reporters\n");
            printf("\n");
            printf("-tc,  --test-case=<filters>\n");

            return 1; // Exit without running tests
        }
        else if(strcmp(argv[i], "-v") == 0 || strcmp(argv[i], "--version") == 0)
        {
            printf("doctest version is \"2.4.12\"\n");

            return 1;
        }
        else if(strcmp(argv[i], "-ltc") == 0 || strcmp(argv[i], "--list-test-cases") == 0)
        {
            UnityArguments.printCases = true;

            return 1;
        }
        else if(strcmp(argv[i], "-lts") == 0 || strcmp(argv[i], "--list-test-suites") == 0)
        {
            UnityArguments.printSuites = true;
            printf("ToDo: Not implemented\n");

            return 1;
        }
        else if(strcmp(argv[i], "-lr") == 0 || strcmp(argv[i], "--list-reporters") == 0)
        {
            UnityArguments.printReporters = true;
            printf("ToDo: Not implemented\n");

            return 1;
        }
        else if(strcmp(argv[i], "-tc") == 0)
        {
            if(i + 1 >= argc)
            {
                printf("No filter passed");
            }
            else
            {
                UnityArguments.caseFilter = argv[i + 1];
            }
            
            return 1;
        }
        else if(UnityStringStartsWith("--test-case=", argv[i]))
        {
            size_t offset = strlen("--test-case=");

            // points to '\0' if no filter is given after argument
            UnityArguments.caseFilter = &(argv[i][offset]);

            return 0;
        }
        else if(strncmp(argv[i], "-", 1) == 0 || strncmp(argv[i], "--", 2) == 0)
        {
            printf("Unknown command line arg: %s\n", argv[i]);
        }
        else
        {
            return 0;
        }
    }
}

bool UnityStringStartsWith(const char *pre, const char *str)
{
    size_t lenpre = strlen(pre),
           lenstr = strlen(str);
    return lenstr < lenpre ? false : memcmp(pre, str, lenpre) == 0;
}